<!-- All-Time P&L Banner -->
{% if alltime %}
<div class="stat-card" style="margin-bottom:16px; padding:20px 24px; border-left:4px solid {{ '#22c55e' if alltime.equity_change >= 0 else '#ef4444' }};">
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px;">
        <div>
            <div class="stat-label" style="margin-bottom:4px;">All-Time P&L</div>
            <div class="stat-value {{ 'positive' if alltime.equity_change >= 0 else 'negative' }} text-mono" style="font-size:28px;">
                {{ "+" if alltime.equity_change >= 0 else "" }}A${{ "%.2f" | format(alltime.equity_change) }}
                <span class="text-sm {{ 'text-success' if alltime.equity_change_pct >= 0 else 'text-danger' }}" style="font-size:16px;">
                    ({{ "+" if alltime.equity_change_pct >= 0 else "" }}{{ "%.2f" | format(alltime.equity_change_pct) }}%)
                </span>
            </div>
            <div class="stat-breakdown text-sm text-muted" style="margin-top:6px;">
                Started: A${{ "%.0f" | format(alltime.starting_capital) }}
                &nbsp;&rarr;&nbsp;
                Now: A${{ "%.0f" | format(alltime.current_equity) }}
                &nbsp;|&nbsp;
                Realised: {{ "+" if alltime.realised_pnl >= 0 else "" }}A${{ "%.2f" | format(alltime.realised_pnl) }}
            </div>
        </div>
        <div style="display:flex; gap:24px; text-align:center;">
            <div>
                <div class="stat-label">Wins</div>
                <div class="text-mono text-success" style="font-size:20px;">{{ alltime.wins }}</div>
            </div>
            <div>
                <div class="stat-label">Losses</div>
                <div class="text-mono text-danger" style="font-size:20px;">{{ alltime.losses }}</div>
            </div>
            <div>
                <div class="stat-label">Win Rate</div>
                <div class="text-mono {{ 'text-success' if alltime.win_rate >= 50 else 'text-warning' if alltime.win_rate >= 40 else 'text-danger' }}" style="font-size:20px;">
                    {{ "%.0f" | format(alltime.win_rate) }}%
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Per-Broker Stats Cards -->
{% if broker_stats and broker_stats|length > 0 %}
<div style="display:grid; grid-template-columns:repeat({{ broker_stats|length }}, 1fr); gap:16px; margin-bottom:16px;">
    {% for bid, bs in broker_stats.items() %}
    <div class="stat-card" style="padding:16px;">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
            <span class="badge {{ 'badge-warning' if bid == 'binance' else 'badge-info' }}">{{ bid|upper }}</span>
        </div>
        <div class="stat-label">Equity</div>
        <div class="stat-value neutral text-mono" style="font-size:22px;">A${{ "%.2f" | format(bs.total_equity) }}</div>
        <div class="stat-breakdown text-sm text-muted" style="margin-top:4px;">
            <span>At Risk: A${{ "%.2f" | format(bs.in_trades) }}</span>
            &nbsp;|&nbsp;
            <span>Avail: A${{ "%.2f" | format(bs.available) }}</span>
        </div>
        <div class="stat-breakdown text-sm" style="margin-top:4px;">
            <span class="{{ 'text-danger' if bs.total_leverage > 10 else 'text-warning' if bs.total_leverage > 5 else 'text-muted' }}">
                Leverage: {{ "%.1f" | format(bs.total_leverage) }}x
            </span>
        </div>
        <hr style="border:0; border-top:1px solid rgba(255,255,255,0.06); margin:10px 0;">
        <div class="stat-label">Daily P&L</div>
        <div class="stat-value {{ 'positive' if bs.daily_pnl >= 0 else 'negative' }}" style="font-size:18px;">
            {{ "+" if bs.daily_pnl >= 0 else "" }}A${{ "%.2f" | format(bs.daily_pnl) }}
            <span class="text-sm {{ 'text-success' if bs.daily_pnl_pct >= 0 else 'text-danger' }}">
                ({{ "+" if bs.daily_pnl_pct >= 0 else "" }}{{ "%.2f" | format(bs.daily_pnl_pct) }}%)
            </span>
        </div>
        <div class="stat-breakdown text-sm text-muted" style="margin-top:4px;">
            <span>Real: {{ "+" if bs.realized_pnl >= 0 else "" }}A${{ "%.2f" | format(bs.realized_pnl) }}</span>
            &nbsp;|&nbsp;
            <span class="{{ 'text-success' if bs.unrealized_pnl >= 0 else 'text-danger' }}">
                Open: {{ "+" if bs.unrealized_pnl >= 0 else "" }}A${{ "%.2f" | format(bs.unrealized_pnl) }}
            </span>
        </div>
        <hr style="border:0; border-top:1px solid rgba(255,255,255,0.06); margin:10px 0;">
        <div style="display:flex; gap:16px;">
            <div>
                <div class="stat-label">Positions</div>
                <div class="text-mono" style="font-size:16px;">{{ bs.open_positions }}</div>
            </div>
            <div>
                <div class="stat-label">Trades</div>
                <div class="text-mono" style="font-size:16px;">{{ bs.daily_trades }}</div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Combined Totals -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Combined Equity</div>
        <div class="stat-value neutral text-mono">A${{ "%.2f" | format(stats.total_equity) }}</div>
        <div class="stat-breakdown text-sm text-muted" style="margin-top:4px;">
            <span>At Risk: A${{ "%.2f" | format(stats.in_trades) }}</span>
            &nbsp;|&nbsp;
            <span>Available: A${{ "%.2f" | format(stats.available) }}</span>
        </div>
        <div class="stat-breakdown text-sm" style="margin-top:4px;">
            <span class="{{ 'text-danger' if stats.total_leverage > 10 else 'text-warning' if stats.total_leverage > 5 else 'text-muted' }}">
                Leverage: {{ "%.1f" | format(stats.total_leverage) }}x
            </span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Combined Daily P&L</div>
        <div class="stat-value {{ 'positive' if stats.daily_pnl >= 0 else 'negative' }}">
            {{ "+" if stats.daily_pnl >= 0 else "" }}A${{ "%.2f" | format(stats.daily_pnl) }}
        </div>
        <div class="stat-change {{ 'text-success' if stats.daily_pnl_pct >= 0 else 'text-danger' }}">
            {{ "+" if stats.daily_pnl_pct >= 0 else "" }}{{ "%.2f" | format(stats.daily_pnl_pct) }}%
        </div>
        <div class="stat-breakdown text-sm text-muted" style="margin-top:4px;">
            <span>Realized: {{ "+" if stats.realized_pnl >= 0 else "" }}A${{ "%.2f" | format(stats.realized_pnl) }}</span>
            &nbsp;|&nbsp;
            <span class="{{ 'text-success' if stats.unrealized_pnl >= 0 else 'text-danger' }}">
                Open: {{ "+" if stats.unrealized_pnl >= 0 else "" }}A${{ "%.2f" | format(stats.unrealized_pnl) }}
            </span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Open Positions</div>
        <div class="stat-value neutral">{{ stats.open_positions }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Trades Today</div>
        <div class="stat-value neutral">{{ stats.daily_trades }}</div>
    </div>
</div>

<!-- Info Panels: Trading Hours + Risk Model -->
<div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px;">

    <!-- Trading Hours Panel -->
    <div class="card">
        <div class="card-header" onclick="var el=document.getElementById('info-hours'); el.style.display=el.style.display==='none'?'block':'none';" style="cursor:pointer;">
            <h2 class="card-title">Trading Hours (Melbourne AEST)</h2>
            <span class="text-muted text-sm">click to expand</span>
        </div>
        <div id="info-hours" style="display:none; padding:0 16px 16px;">
            <table style="width:100%; font-size:13px;">
                <thead>
                    <tr>
                        <th style="text-align:left; padding:6px 8px;">Market</th>
                        <th style="text-align:left; padding:6px 8px;">What We Trade</th>
                        <th style="text-align:left; padding:6px 8px;">Open</th>
                        <th style="text-align:left; padding:6px 8px; color:#f87171;">Closed</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding:6px 8px; font-weight:600;">Crypto</td>
                        <td style="padding:6px 8px;" class="text-muted">BTC/USDT (Binance)</td>
                        <td style="padding:6px 8px; color:#4ade80;">24/7 &mdash; never closes</td>
                        <td style="padding:6px 8px; color:#4ade80;">&mdash;</td>
                    </tr>
                    <tr>
                        <td style="padding:6px 8px; font-weight:600;">Forex</td>
                        <td style="padding:6px 8px;" class="text-muted">15 currency pairs</td>
                        <td style="padding:6px 8px;">Mon 7:00am &ndash; Sat 7:00am</td>
                        <td style="padding:6px 8px; color:#f87171; font-weight:600;">Sat 7am &ndash; Mon 7am</td>
                    </tr>
                    <tr>
                        <td style="padding:6px 8px; font-weight:600;">Metals</td>
                        <td style="padding:6px 8px;" class="text-muted">Gold, Silver</td>
                        <td style="padding:6px 8px;">Mon 7:00am &ndash; Sat 7:00am</td>
                        <td style="padding:6px 8px; color:#f87171; font-weight:600;">Sat 7am &ndash; Mon 7am<br><span class="text-sm" style="color:#fbbf24;">Daily break ~8&ndash;9am</span></td>
                    </tr>
                    <tr>
                        <td style="padding:6px 8px; font-weight:600;">Energy</td>
                        <td style="padding:6px 8px;" class="text-muted">WTI Oil, Brent, Nat Gas, Copper</td>
                        <td style="padding:6px 8px;">Mon 8:00am &ndash; Sat 7:00am</td>
                        <td style="padding:6px 8px; color:#f87171; font-weight:600;">Sat 7am &ndash; Mon 8am<br><span class="text-sm" style="color:#fbbf24;">Daily break ~7&ndash;8am</span></td>
                    </tr>
                    <tr>
                        <td style="padding:6px 8px; font-weight:600;">Indices</td>
                        <td style="padding:6px 8px;" class="text-muted">S&P500, Nasdaq, Dow, ASX200, DAX, FTSE, Nikkei, Russell</td>
                        <td style="padding:6px 8px;">Mon ~8:00am &ndash; Sat ~7:00am</td>
                        <td style="padding:6px 8px; color:#f87171; font-weight:600;">Sat ~7am &ndash; Mon ~8am<br><span class="text-sm" style="color:#fbbf24;">Daily breaks vary (15&ndash;60 min)</span></td>
                    </tr>
                    <tr>
                        <td style="padding:6px 8px; font-weight:600;">Bonds</td>
                        <td style="padding:6px 8px;" class="text-muted">US 10-Year Treasury</td>
                        <td style="padding:6px 8px;">Mon ~8:00am &ndash; Sat ~7:00am</td>
                        <td style="padding:6px 8px; color:#f87171; font-weight:600;">Sat ~7am &ndash; Mon ~8am<br><span class="text-sm" style="color:#fbbf24;">Daily break ~7&ndash;8am</span></td>
                    </tr>
                </tbody>
            </table>
            <div style="margin-top:12px; padding:10px 12px; background:rgba(248,113,113,0.08); border:1px solid rgba(248,113,113,0.2); border-radius:6px;">
                <span style="color:#f87171; font-weight:600;">Weekend gap risk:</span>
                <span class="text-sm text-muted">
                    Positions held over closed periods carry risk &mdash; price can jump when the market reopens
                    and stop losses won't trigger until trading resumes. The bot does not close positions before weekends.
                </span>
            </div>
        </div>
    </div>

    <!-- Risk Model Panel -->
    <div class="card">
        <div class="card-header" onclick="var el=document.getElementById('info-risk'); el.style.display=el.style.display==='none'?'block':'none';" style="cursor:pointer;">
            <h2 class="card-title">Risk Model &amp; Rules</h2>
            <span class="text-muted text-sm">click to expand</span>
        </div>
        <div id="info-risk" style="display:none; padding:0 16px 16px;">
            <div style="font-size:13px; line-height:1.7;">

                <div style="font-weight:600; margin-bottom:4px; color:#93c5fd;">How much do we risk per trade?</div>
                <p class="text-muted" style="margin:0 0 12px;">
                    Each trade risks <strong style="color:#e2e8f0;">2% of the broker's equity</strong>.
                    On a A$10,000 account that's A$200 max loss per trade.
                    Position size is calculated using ATR (Average True Range) so the stop loss
                    is wider in volatile markets and tighter in calm ones &mdash; the dollar risk stays the same.
                </p>

                <div style="font-weight:600; margin-bottom:4px; color:#93c5fd;">How are stop losses set?</div>
                <p class="text-muted" style="margin:0 0 12px;">
                    Stop losses are placed based on the instrument's ATR &mdash; a measure of how much
                    the price typically moves. This means stops adapt to each market's volatility
                    rather than using fixed pip/dollar amounts. The bot verifies every stop is on the
                    correct side of the entry price.
                </p>

                <div style="font-weight:600; margin-bottom:4px; color:#93c5fd;">Trailing stop loss (breakeven + profit lock)</div>
                <p class="text-muted" style="margin:0 0 12px;">
                    Once a position moves in profit, the stop loss is automatically tightened in two stages:<br>
                    <strong style="color:#e2e8f0;">Stage 1 &mdash; Breakeven (50%):</strong>
                    When price reaches 50% of the way to TP1, the SL moves to the entry price &mdash; the trade can no longer lose money.<br>
                    <strong style="color:#e2e8f0;">Stage 2 &mdash; Profit Lock (75%):</strong>
                    When price reaches 75% of the way to TP1, the SL moves to lock in 25% of the move.<br>
                    <span class="text-sm">Checked every 2 minutes. Shown as
                    <span class="badge badge-info" style="font-size:9px;">BE</span> and
                    <span class="badge badge-success" style="font-size:9px;">LOCK</span>
                    badges on the positions page.</span>
                </p>

                <div style="font-weight:600; margin-bottom:4px; color:#93c5fd;">Maximum positions allowed</div>
                <p class="text-muted" style="margin:0 0 12px;">
                    <strong style="color:#e2e8f0;">4&ndash;5 positions per broker</strong> (Binance: 2, OANDA: 5, IG: 5 = 12 total max).<br>
                    Within each broker, a maximum of <strong style="color:#e2e8f0;">4 same-direction forex</strong>,
                    <strong style="color:#e2e8f0;">3 index</strong>, and
                    <strong style="color:#e2e8f0;">3 commodity</strong> trades can be open at once
                    to limit correlated exposure. No duplicate positions on the same symbol.
                </p>

                <div style="font-weight:600; margin-bottom:4px; color:#93c5fd;">What about leverage?</div>
                <p class="text-muted" style="margin:0 0 12px;">
                    Each instrument has a per-position leverage cap:
                    <strong style="color:#e2e8f0;">Forex 20&ndash;30x</strong>,
                    <strong style="color:#e2e8f0;">Commodities/Indices 10&ndash;20x</strong>,
                    <strong style="color:#e2e8f0;">Crypto 1x</strong> (spot, no leverage).<br>
                    <strong style="color:#fbbf24;">Portfolio leverage cap: 10x</strong> &mdash;
                    new trades are blocked if aggregate notional exposure / equity exceeds 10x
                    on any broker. Crypto notional is capped at 50% of equity per position.
                </p>

                <div style="font-weight:600; margin-bottom:4px; color:#93c5fd;">Signal quality gates</div>
                <p class="text-muted" style="margin:0 0 12px;">
                    <strong style="color:#e2e8f0;">ADX trend filter (crypto):</strong>
                    Crypto signals are rejected when ADX &lt; 20 &mdash; the market is too choppy for divergence to work reliably.<br>
                    <strong style="color:#e2e8f0;">Ranging market filter:</strong>
                    All signals are rejected when ADX &lt; 25 AND the 200 EMA slope is flat (&lt; 0.05% over 10 bars)
                    &mdash; divergence in a trendless, low-energy market has very low probability.
                </p>

                <div style="font-weight:600; margin-bottom:4px; color:#93c5fd;">Emergency safety nets</div>
                <p class="text-muted" style="margin:0 0 12px;">
                    <strong style="color:#fbbf24;">Daily loss circuit breaker:</strong>
                    If losses exceed <strong style="color:#e2e8f0;">5% of equity</strong> in a single day,
                    all new trading stops automatically until the next day.<br>
                    <strong style="color:#f87171;">Drawdown kill switch:</strong>
                    A persistent emergency stop that requires manual override to resume trading.
                </p>

                <div style="font-weight:600; margin-bottom:4px; color:#93c5fd;">Starting capital</div>
                <p class="text-muted" style="margin:0 0 0;">
                    Binance: <strong style="color:#e2e8f0;">A$12,160</strong> (US$7,600) &nbsp;+&nbsp;
                    OANDA: <strong style="color:#e2e8f0;">A$10,000</strong> &nbsp;+&nbsp;
                    IG: <strong style="color:#e2e8f0;">A$10,000</strong> &nbsp;=&nbsp;
                    <strong style="color:#e2e8f0;">A$32,160 total</strong>
                </p>
            </div>
        </div>
    </div>

</div>

<!-- Two-column: Recent Signals + Analysis Cycles -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">

    <!-- Recent Signals -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Recent Signals</h2>
            <a href="/dashboard/signals" class="text-muted text-sm" style="text-decoration:none;">View all</a>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Symbol</th>
                        <th>Type</th>
                        <th>Conf.</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in signals %}
                    <tr>
                        <td class="mono text-sm">{{ (s.created_at|to_melb).strftime('%H:%M:%S') }}</td>
                        <td>{{ s.symbol }}</td>
                        <td>
                            {% if s.direction %}
                            <span class="badge badge-{{ s.direction }}">{{ s.direction }}</span>
                            {% endif %}
                            <span class="text-sm text-muted">{{ s.divergence_type }}</span>
                        </td>
                        <td class="mono">{{ "%.0f" | format(s.confidence * 100) }}%</td>
                        <td>
                            {% if s.validated %}
                            <span class="badge badge-success">Pass</span>
                            {% else %}
                            <span class="badge badge-danger">Reject</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="5" class="text-muted text-sm" style="text-align:center;padding:32px;">No signals yet</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Analysis Cycles -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Analysis Cycles</h2>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Duration</th>
                        <th>Checked</th>
                        <th>Found</th>
                        <th>Valid</th>
                        <th>Orders</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in cycles %}
                    {% set symbols_data = c.errors.get('symbols', {}) if c.errors and c.errors is mapping else {} %}
                    <tr class="expand-trigger" onclick="toggleExpand('cycle-{{ loop.index }}')">
                        <td class="mono text-sm">{{ (c.started_at|to_melb).strftime('%H:%M:%S') }}</td>
                        <td class="mono">{{ c.duration_ms or 0 }}ms</td>
                        <td class="mono">{{ c.symbols_analyzed|length }}</td>
                        <td class="mono">{{ c.signals_found }}</td>
                        <td class="mono">{{ c.signals_validated }}</td>
                        <td class="mono">{{ c.orders_placed }}</td>
                    </tr>
                    {% if symbols_data %}
                    <tr class="expand-content" id="cycle-{{ loop.index }}">
                        <td colspan="6">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:4px 24px;">
                                {% for sym, status in symbols_data.items() %}
                                <div style="display:flex; justify-content:space-between; padding:2px 0;">
                                    <span class="mono text-sm">{{ sym }}</span>
                                    {% if status == 'order_placed' %}
                                    <span class="badge badge-success" style="font-size:10px;">ORDER</span>
                                    {% elif status == 'no_divergence' %}
                                    <span class="text-muted text-sm">no divergence</span>
                                    {% elif status == 'no_new_candle' %}
                                    <span class="text-dim text-sm" style="color:var(--text-dim);">no new candle</span>
                                    {% elif 'signal_rejected' in status %}
                                    <span class="badge badge-warning" style="font-size:10px;">REJECTED</span>
                                    {% elif 'signal_validated' in status %}
                                    <span class="badge badge-info" style="font-size:10px;">VALIDATED</span>
                                    {% elif 'insufficient' in status %}
                                    <span class="badge badge-muted" style="font-size:10px;">LOW DATA</span>
                                    {% elif 'error' in status %}
                                    <span class="badge badge-danger" style="font-size:10px;">ERROR</span>
                                    {% else %}
                                    <span class="text-muted text-sm">{{ status }}</span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    {% else %}
                    <tr><td colspan="6" class="text-muted text-sm" style="text-align:center;padding:32px;">No cycles yet</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>
