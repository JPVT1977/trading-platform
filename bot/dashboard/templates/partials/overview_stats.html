<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Total Equity</div>
        <div class="stat-value neutral text-mono">${{ "%.2f" | format(stats.total_equity) }}</div>
        <div class="stat-breakdown text-sm text-muted" style="margin-top:4px;">
            <span>At Risk: ${{ "%.2f" | format(stats.in_trades) }}</span>
            &nbsp;|&nbsp;
            <span>Available: ${{ "%.2f" | format(stats.available) }}</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Daily P&L</div>
        <div class="stat-value {{ 'positive' if stats.daily_pnl >= 0 else 'negative' }}">
            {{ "+" if stats.daily_pnl >= 0 else "" }}${{ "%.2f" | format(stats.daily_pnl) }}
        </div>
        <div class="stat-change {{ 'text-success' if stats.daily_pnl_pct >= 0 else 'text-danger' }}">
            {{ "+" if stats.daily_pnl_pct >= 0 else "" }}{{ "%.2f" | format(stats.daily_pnl_pct) }}%
        </div>
        <div class="stat-breakdown text-sm text-muted" style="margin-top:4px;">
            <span>Realized: {{ "+" if stats.realized_pnl >= 0 else "" }}${{ "%.2f" | format(stats.realized_pnl) }}</span>
            &nbsp;|&nbsp;
            <span class="{{ 'text-success' if stats.unrealized_pnl >= 0 else 'text-danger' }}">
                Open: {{ "+" if stats.unrealized_pnl >= 0 else "" }}${{ "%.2f" | format(stats.unrealized_pnl) }}
            </span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Open Positions</div>
        <div class="stat-value neutral">{{ stats.open_positions }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Trades Today</div>
        <div class="stat-value neutral">{{ stats.daily_trades }}</div>
    </div>
</div>

<!-- Two-column: Recent Signals + Analysis Cycles -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">

    <!-- Recent Signals -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Recent Signals</h2>
            <a href="/dashboard/signals" class="text-muted text-sm" style="text-decoration:none;">View all</a>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Symbol</th>
                        <th>Type</th>
                        <th>Conf.</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in signals %}
                    <tr>
                        <td class="mono text-sm">{{ (s.created_at|to_melb).strftime('%H:%M:%S') }}</td>
                        <td>{{ s.symbol }}</td>
                        <td>
                            {% if s.direction %}
                            <span class="badge badge-{{ s.direction }}">{{ s.direction }}</span>
                            {% endif %}
                            <span class="text-sm text-muted">{{ s.divergence_type }}</span>
                        </td>
                        <td class="mono">{{ "%.0f" | format(s.confidence * 100) }}%</td>
                        <td>
                            {% if s.validated %}
                            <span class="badge badge-success">Pass</span>
                            {% else %}
                            <span class="badge badge-danger">Reject</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="5" class="text-muted text-sm" style="text-align:center;padding:32px;">No signals yet</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Analysis Cycles -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Analysis Cycles</h2>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Duration</th>
                        <th>Checked</th>
                        <th>Found</th>
                        <th>Valid</th>
                        <th>Orders</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in cycles %}
                    {% set symbols_data = c.errors.get('symbols', {}) if c.errors and c.errors is mapping else {} %}
                    <tr class="expand-trigger" onclick="toggleExpand('cycle-{{ loop.index }}')">
                        <td class="mono text-sm">{{ (c.started_at|to_melb).strftime('%H:%M:%S') }}</td>
                        <td class="mono">{{ c.duration_ms or 0 }}ms</td>
                        <td class="mono">{{ c.symbols_analyzed|length }}</td>
                        <td class="mono">{{ c.signals_found }}</td>
                        <td class="mono">{{ c.signals_validated }}</td>
                        <td class="mono">{{ c.orders_placed }}</td>
                    </tr>
                    {% if symbols_data %}
                    <tr class="expand-content" id="cycle-{{ loop.index }}">
                        <td colspan="6">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:4px 24px;">
                                {% for sym, status in symbols_data.items() %}
                                <div style="display:flex; justify-content:space-between; padding:2px 0;">
                                    <span class="mono text-sm">{{ sym }}</span>
                                    {% if status == 'order_placed' %}
                                    <span class="badge badge-success" style="font-size:10px;">ORDER</span>
                                    {% elif status == 'no_divergence' %}
                                    <span class="text-muted text-sm">no divergence</span>
                                    {% elif status == 'no_new_candle' %}
                                    <span class="text-dim text-sm" style="color:var(--text-dim);">no new candle</span>
                                    {% elif 'signal_rejected' in status %}
                                    <span class="badge badge-warning" style="font-size:10px;">REJECTED</span>
                                    {% elif 'signal_validated' in status %}
                                    <span class="badge badge-info" style="font-size:10px;">VALIDATED</span>
                                    {% elif 'insufficient' in status %}
                                    <span class="badge badge-muted" style="font-size:10px;">LOW DATA</span>
                                    {% elif 'error' in status %}
                                    <span class="badge badge-danger" style="font-size:10px;">ERROR</span>
                                    {% else %}
                                    <span class="text-muted text-sm">{{ status }}</span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    {% else %}
                    <tr><td colspan="6" class="text-muted text-sm" style="text-align:center;padding:32px;">No cycles yet</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>
