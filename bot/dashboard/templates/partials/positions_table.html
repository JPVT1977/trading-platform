<!-- Positions HTMX partial â€” tabs + detailed tables -->
<div class="tabs">
    <button class="tab {{ 'active' if tab == 'open' else '' }}"
            data-tab-group="positions" data-tab="open"
            onclick="switchTab('positions', 'open')">
        Open ({{ open_positions | length }})
    </button>
    <button class="tab {{ 'active' if tab == 'closed' else '' }}"
            data-tab-group="positions" data-tab="closed"
            onclick="switchTab('positions', 'closed')">
        Closed ({{ closed_total }})
    </button>
</div>

<!-- Open Positions -->
<div data-tab-content="positions" data-tab-pane="open" style="{{ 'display:none' if tab != 'open' else '' }}">
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Broker</th>
                    <th>Direction</th>
                    <th>Entry</th>
                    <th>Current</th>
                    <th>P&L</th>
                    <th>SL</th>
                    <th>TP1</th>
                    <th>Qty</th>
                    <th>State</th>
                    <th>Opened</th>
                    <th>Duration</th>
                </tr>
            </thead>
            <tbody>
                {% for p in open_positions %}
                <tr class="expand-trigger" onclick="toggleExpand('open-{{ p.id }}')">
                    <td><strong>{{ p.symbol }}</strong></td>
                    <td>
                        {% if p.broker is defined and p.broker == 'oanda' %}
                        <span class="badge badge-info" style="font-size:10px;">OANDA</span>
                        {% else %}
                        <span class="badge badge-muted" style="font-size:10px;">Binance</span>
                        {% endif %}
                    </td>
                    <td><span class="badge badge-{{ p.direction }}">{{ p.direction }}</span></td>
                    <td class="mono">{{ "%.2f" | format(p.entry_price) }}</td>
                    <td class="mono">
                        {% if p.current_price is not none %}
                        {{ "%.2f" | format(p.current_price) }}
                        {% else %}-{% endif %}
                    </td>
                    <td class="mono">
                        {% if p.unrealized_pnl is not none %}
                        <span class="{{ 'text-success' if p.unrealized_pnl >= 0 else 'text-danger' }}">
                            {{ "+" if p.unrealized_pnl >= 0 else "" }}${{ "%.2f" | format(p.unrealized_pnl) }}
                        </span>
                        <div class="text-sm {{ 'text-success' if p.pnl_pct >= 0 else 'text-danger' }}">
                            {{ "+" if p.pnl_pct >= 0 else "" }}{{ "%.2f" | format(p.pnl_pct) }}%
                        </div>
                        {% else %}-{% endif %}
                    </td>
                    <td class="mono">{{ "%.2f" | format(p.stop_loss) }}</td>
                    <td class="mono">{{ "%.2f" | format(p.take_profit_1) }}</td>
                    <td class="mono">{{ "%.6f" | format(p.quantity) }}</td>
                    <td><span class="badge badge-info">{{ p.state }}</span></td>
                    <td class="mono text-sm">{{ (p.created_at|to_melb).strftime('%m-%d %H:%M') }}</td>
                    <td class="mono text-sm text-muted">
                        {% set delta = now - p.created_at %}
                        {% if delta.days > 0 %}{{ delta.days }}d {% endif %}{{ (delta.seconds // 3600) }}h {{ (delta.seconds % 3600 // 60) }}m
                    </td>
                </tr>
                <tr class="expand-content" id="expand-open-{{ p.id }}">
                    <td colspan="12">
                        <strong>Trigger:</strong> {{ p.divergence_type or '-' }} / {{ p.indicator or '-' }}
                        &nbsp;|&nbsp; <strong>Confidence:</strong> {{ "%.0f" | format(p.confidence * 100) if p.confidence else '-' }}%
                        <br><strong>Signal Reasoning:</strong> {{ p.reasoning or 'N/A' }}
                        {% if p.take_profit_2 %}<br><strong>TP2:</strong> {{ "%.2f" | format(p.take_profit_2) }}{% endif %}
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="12" class="text-muted" style="text-align:center;padding:40px;">No open positions</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Closed Positions -->
<div data-tab-content="positions" data-tab-pane="closed" style="{{ 'display:none' if tab != 'closed' else '' }}">
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Broker</th>
                    <th>Direction</th>
                    <th>Trigger</th>
                    <th>Confidence</th>
                    <th>Entry</th>
                    <th>Fill</th>
                    <th>P&L</th>
                    <th>Fees</th>
                    <th>Duration</th>
                    <th>Closed</th>
                </tr>
            </thead>
            <tbody>
                {% for p in closed_positions %}
                <tr class="expand-trigger" onclick="toggleExpand('closed-{{ p.id }}')">
                    <td><strong>{{ p.symbol }}</strong></td>
                    <td>
                        {% if p.broker is defined and p.broker == 'oanda' %}
                        <span class="badge badge-info" style="font-size:10px;">OANDA</span>
                        {% else %}
                        <span class="badge badge-muted" style="font-size:10px;">Binance</span>
                        {% endif %}
                    </td>
                    <td><span class="badge badge-{{ p.direction }}">{{ p.direction }}</span></td>
                    <td class="text-sm">{{ p.divergence_type or '-' }} / {{ p.indicator or '-' }}</td>
                    <td class="mono">{{ "%.0f" | format(p.confidence * 100) if p.confidence else '-' }}%</td>
                    <td class="mono">{{ "%.2f" | format(p.entry_price) }}</td>
                    <td class="mono">{{ "%.2f" | format(p.filled_price) if p.filled_price else '-' }}</td>
                    <td class="mono {{ 'text-success' if p.pnl and p.pnl >= 0 else 'text-danger' }}">
                        {{ "%.2f" | format(p.pnl) if p.pnl is not none else '-' }}
                    </td>
                    <td class="mono text-muted">{{ "%.2f" | format(p.fees) if p.fees else '0.00' }}</td>
                    <td class="mono text-sm">
                        {% if p.closed_at and p.created_at %}
                        {% set delta = p.closed_at - p.created_at %}
                        {% if delta.days > 0 %}{{ delta.days }}d {% endif %}{{ (delta.seconds // 3600) }}h {{ (delta.seconds % 3600 // 60) }}m
                        {% else %}-{% endif %}
                    </td>
                    <td class="mono text-sm">{{ (p.closed_at|to_melb).strftime('%m-%d %H:%M') if p.closed_at else '-' }}</td>
                </tr>
                <tr class="expand-content" id="expand-closed-{{ p.id }}">
                    <td colspan="11">
                        <strong>Signal Reasoning:</strong> {{ p.reasoning or 'N/A' }}
                        <br><strong>SL:</strong> {{ "%.2f" | format(p.stop_loss) }} | <strong>TP1:</strong> {{ "%.2f" | format(p.take_profit_1) }}
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="11" class="text-muted" style="text-align:center;padding:40px;">No closed positions</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if closed_total_pages > 1 %}
    <div class="pagination">
        {% if closed_page > 1 %}
        <a href="/dashboard/positions?tab=closed&page={{ closed_page - 1 }}">Prev</a>
        {% endif %}
        {% for p in range(1, closed_total_pages + 1) %}
            {% if p == closed_page %}
            <span class="current">{{ p }}</span>
            {% elif p <= 3 or p >= closed_total_pages - 2 or (p >= closed_page - 1 and p <= closed_page + 1) %}
            <a href="/dashboard/positions?tab=closed&page={{ p }}">{{ p }}</a>
            {% endif %}
        {% endfor %}
        {% if closed_page < closed_total_pages %}
        <a href="/dashboard/positions?tab=closed&page={{ closed_page + 1 }}">Next</a>
        {% endif %}
    </div>
    {% endif %}
</div>
